<!DOCTYPE html>
<html>
<head>
    <% include ../partials/header.ejs %>
</head>

<body>

<script>
    let profile;
    let idToken;

    function getGuesses() {
        $('#guesses').html("Analysing...");
        $.get("/getGuessesDiv", $('#form').serialize(), function (data) {
            $('#guesses').html(data);
        })
    }

    function insertTextToTextArea(text) {
        $('#editTextBox').val(text);
    }

    function onSignIn(googleUser) {
        profile = googleUser.getBasicProfile();
        idToken = googleUser.getAuthResponse().id_token;
        $.post('/signIn', {idToken: idToken}, (data) => {
            console.log("onSignIn again");
            $('#userTextBlocks').html(data);
        })
    }

    function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
            console.log('User signed out.');
            $('#userTextBlocks').html('');
        });
    }

    function saveTextBlock() {
        // todo: see if user signed in
        // if (!signedIn) {
        //     return;
        // }

        let textBlockSaveObject = {
            idToken: idToken,
            title: "Placeholder title",
            textBlock: $("#editTextBox").val()
        }
        console.log(textBlockSaveObject);
        $.post('/saveBlock', textBlockSaveObject, (data) => {
            console.log(data);
            $('#userTextBlocks').html(data);
        })
    }

    function deleteText(element, id) {
        // todo: see if user signed in
        // if (!signedIn) {
        //     return;
        // }

        let textBlockSaveObject = {
            idToken: idToken,
            textBlockId: id
        }
        console.log(textBlockSaveObject);
        $.post('/deleteBlock', textBlockSaveObject, (data) => {
            console.log(data);
            $('#userTextBlocks').html(data);
        })
    }

</script>

<div class="container">
    <% include ../partials/nav.ejs %>
    <div class="d-flex flex-wrap justify-content-center">
        <div class="p-2 flex-grow-1">
            <form id="form">
                <div class="d-flex">
                    <div class="pr-2 mt-auto"><label class="mb-0" for="editTextBox">Text to analyze: </label></div>
                    <div class="pl-2 flex-grow-1"><textarea id='editTextBox' class="form-control"
                                                            name="text"></textarea></div>
                </div>
            </form>
        </div>
        <div class="p-2 mt-auto">
            <button class="btn btn-outline-primary" onclick="saveTextBlock()">Save</button>
            <button class="ml-1 btn btn-outline-primary" onclick="getGuesses()">Analyze</button>
        </div>
    </div>
    <div id="guesses"></div>

    <div id="userTextBlocks"></div>
    <% include ../partials/textBlocksListDiv.ejs %>

</div>

</body>
</html>
